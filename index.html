<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cricket Run Counter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* (Unchanged CSS from your original code) */
    body { background: #e5f3ff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 480px; margin: 30px auto 0; background: #fff; border-radius: 14px; box-shadow: 0 4px 18px rgba(0,0,0,0.11); padding: 20px 16px 28px; display: flex; flex-direction: column; }
    .scoreboard { display: flex; align-items: flex-end; justify-content: center; gap: 12px; font-size: 2.7rem; margin-bottom: 10px; }
    .score { font-size: 3.4rem; font-weight: bold; color: #1976d2; }
    .divider { font-size: 2.6rem; color: #888; }
    .overs { font-size: 1.4rem; margin-left: 14px; color: #333; }
    .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; flex: 1; }
    .my-btn { padding: 13px 0; width: 94px; font-size: 1.06rem; border: none; border-radius: 8px; background: #1976d2; color: white; cursor: pointer; font-weight: 500; transition: background 0.18s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .my-btn:hover, .my-btn:focus { background: #0d47a1; }
    .my-btn.secondary { background: #f0f4c3; color: #393; }
    .my-btn.danger { background: #e57373; color: #fff; }
    .my-btn.grey { background: #eee; color: #333; }
    .btn-group { display: flex; gap: 7px; margin-bottom: 8px; flex-wrap: wrap; justify-content: center; }
    .alert { background: #e3f2fd; color: #1565c0; padding: 8px 10px; border-radius: 6px; text-align: center; margin: 12px 0; display: none; }
    .top-buttons { display: flex; justify-content: space-between; margin-top: 16px; gap: 7px; flex-wrap: wrap; }
    .top-buttons button { flex: 1 1 calc(33% - 10px); }
    .reset-btn { background: #ffecb3; color: #e65100; border: none; padding: 12px 0; border-radius: 8px; width: 100%; font-size: 1.06rem; font-weight: bold; cursor: pointer; }
    .reset-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .modal-backdrop { position: fixed; top: 0; left: 0; bottom: 0; right: 0; background: rgba(0,0,0,0.34); z-index: 10; display: none; }
    .modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 10px; box-shadow: 0 8px 36px rgba(0,0,0,0.19); padding: 22px 20px 18px; z-index: 20; min-width: 280px; max-width: 94vw; display: none; }
    .modal h2 { font-size: 1.4rem; margin-bottom: 8px; color: #1976d2; }
    .close-modal { position: absolute; right: 12px; top: 10px; background: #eee; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 1.25rem; color: #777; cursor: pointer; transition: background 0.2s;}
    .close-modal:hover { background: #ffcdd2; color: #d32f2f; }
    .controls { display: flex; justify-content: space-between; margin: 12px 0 15px; gap: 14px; }
    .controls label { font-size: 1.05rem; flex: 0 0 44%; align-self: center; }
    .controls input[type="text"], .controls input[type="number"] { width: 95px; padding: 11px 9px; border: 1.6px solid #bdbdbd; border-radius: 6px; font-size: 1.18rem; }
    .bats­men-row { margin: 12px 0 8px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
    .batsman-box { background: #e3f2fd; padding: 8px 10px; border-radius: 6px; min-width: 40%; position: relative; display: flex; flex-direction: column; }
    .batsman-name { font-weight: bold; color: #1565c0; font-size: 1.15rem; margin-bottom: 2px; }
    .batsman-score { color: #1565c0; font-size: 1rem; margin-bottom: 1px; }
    .batsman-status { font-size: 0.95rem; color: #e57373; margin-bottom: 4px; }
    .declare-btn { margin-top: 4px; padding: 4px 14px; font-size: 0.98rem; border-radius: 8px; background: #ffecb3; border: none; color: #e65100; cursor: pointer; }
    .declare-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    @media (max-width: 550px) {
      .btn-group { flex-direction: row; flex-wrap: wrap; justify-content: center; }
      .btn-group .my-btn { width: 48%; min-width: 44%; }
      .top-buttons { flex-direction: column; }
      .top-buttons button { width: 100%; }
      .controls input[type="text"], .controls input[type="number"] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Scoreboard UI -->
    <div class="scoreboard">
      <span id="run" class="score">0</span><span class="divider">/</span><span id="wickets" class="score">0</span>
      <span id="over-ball" class="overs">0.0</span>
    </div>
    <div class="bats­men-row" id="bats­men-row"></div>

    <!-- Buttons -->
    <div class="action-buttons" id="scoring-buttons">
      <div class="btn-group">
        <button class="my-btn grey" id="run_dot">Dot</button>
        <button class="my-btn grey" id="run_wide">Wide</button>
        <button class="my-btn grey" id="run_no_ball">No ball</button>
        <button class="my-btn grey" id="run_W">Wicket</button>
      </div>
      <div class="btn-group">
        <button class="my-btn" id="run_1">1</button>
        <button class="my-btn" id="run_2">2</button>
        <button class="my-btn" id="run_3">3</button>
        <button class="my-btn" id="run_4">4</button>
        <button class="my-btn" id="run_6">6</button>
      </div>
      <div class="btn-group">
        <button class="my-btn secondary" id="scoreboard-btn">Scoreboard</button>
        <button class="my-btn danger" id="undo-btn">Undo</button>
        <button class="my-btn" id="targetModeButton">Target mode</button>
      </div>
    </div>

    <div class="alert" id="targetBoard">
      Require <span id="targetRunsRequired"></span> runs in <span id="targetOversLeft"></span> balls
      <button type="button" class="close-modal" style="float:right;margin-left:10px;" onclick="closeTargetAlert()">&times;</button>
    </div>

    <div class="top-buttons">
      <button class="my-btn secondary" id="player-score-btn">Show Players</button>
      <button class="my-btn" id="strike-change-btn">Change Strike</button>
      <button class="reset-btn" id="reset-btn" style="display:none;">Start New Score</button>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modal-backdrop"></div>
  <div class="modal" id="scoreboard-modal">...</div>
  <div class="modal" id="player-score-modal">...</div>
  <div class="modal" id="target-modal">...</div>
  <div class="modal" id="batsman-modal">...</div>
  <div class="modal" id="extra-run-modal">...</div>

  <script>
    // State variables
    let run = 0, wickets = 0, balls = 0, over = 0, extraRunsTotal = 0;
    let scoreHistory = [], scoreboardBalls = [];
    let bats­men = [], bats­menOrder = [], onCrease = [null, null];
    let declared = [];
    let targetActive = false, targetRuns = 0, targetBalls = 0;
    let scoringStarted = false;
    let extraRunCallback = null, extraRunValue = 0;

    // Load state (only once)
    function loadState() {
      try {
        const s = JSON.parse(localStorage.getItem('scoreState'));
        if (s && !s.resetTriggered) {
          Object.assign(window, s);
        }
      } catch (e) { console.warn(e); }
    }

    // Save state
    function saveState() {
      const state = {
        run, wickets, balls, over, extraRunsTotal,
        scoreHistory, scoreboardBalls, bats­men, bats­menOrder, onCrease,
        declared, targetActive, targetRuns, targetBalls, scoringStarted,
        resetTriggered: false
      };
      localStorage.setItem('scoreState', JSON.stringify(state));
    }

    // Clear state for new match
    function resetState() {
      run = wickets = balls = over = extraRunsTotal = 0;
      scoreHistory = scoreboardBalls = [];
      bats­men = []; bats­menOrder = []; onCrease = [null, null];
      declared = [];
      targetActive = false; targetRuns = targetBalls = 0;
      scoringStarted = false;

      const state = { resetTriggered: true };
      localStorage.setItem('scoreState', JSON.stringify(state));
      location.reload();
    }

    // Update UI
    function updateDisplay() {
      document.getElementById('run').textContent = run;
      document.getElementById('wickets').textContent = wickets;
      document.getElementById('over-ball').textContent = `${over}.${balls}`;
      showBats­men();

      document.getElementById('reset-btn').style.display = scoringStarted ? '' : 'none';
      if (targetActive) updateTargetBoard();

      saveState();
    }

    // Batsmen display
    function showBats­men() {
      const row = document.getElementById('bats­men-row');
      row.innerHTML = '';
      for (let i = 0; i < 2; i++) {
        const idx = onCrease[i];
        if (idx === null || !bats­men[idx]) continue;
        const b = bats­men[idx];
        const status = b.declared ? 'Declared' : b.out ? 'Out' : 'Not out';
        const isStriker = i === 0 ? ' (Striker)' : '';
        row.innerHTML += `
          <div class="batsman-box">
            <div class="batsman-name">${b.name}${isStriker}</div>
            <div class="batsman-score">Runs: ${b.runs} | Balls: ${b.balls}</div>
            <div class="batsman-status">${status}</div>
            <button class="declare-btn" onclick="declareBatsman(${idx})" ${b.declared || b.out ? 'disabled' : ''}>Declare</button>
          </div>`;
      }
    }

    // Show batsman input modal
    function showBatsmanModal(type, cb) {
      const title = type === 'openers' ? 'Enter opening batsmen names' : 'Enter new batsman name';
      document.getElementById('batsman-modal-title').textContent = title;

      const inputs = document.getElementById('batsman-modal-inputs');
      inputs.innerHTML = type === 'openers'
        ? `<input type="text" id="batsman1" placeholder="Batsman 1" required><br>
           <input type="text" id="batsman2" placeholder="Batsman 2" required>`
        : `<input type="text" id="batsmanNew" placeholder="New batsman" required>`;

      const submitBtn = document.getElementById('batsman-modal-submit');
      submitBtn.onclick = e => {
        e.preventDefault();
        if (type === 'openers') {
          const n1 = document.getElementById('batsman1').value.trim();
          const n2 = document.getElementById('batsman2').value.trim();
          if (!n1 || !n2) return;
          cb(n1, n2);
        } else {
          const n = document.getElementById('batsmanNew').value.trim();
          if (!n) return;
          cb(n);
        }
        hideModal('batsman-modal');
      };

      showModal('batsman-modal');
    }

    // Declare batsman out
    function declareBatsman(idx) {
      bats­men[idx].declared = true;
      const p = onCrease.indexOf(idx);
      if (p !== -1) onCrease[p] = null;
      updateDisplay();
      setTimeout(() => showBatsmanModal('new', addBatsman), 300);
    }

    // Add new batsman
    function addBatsman(name) {
      const idx = bats­men.length;
      bats­men.push({ name, runs: 0, balls: 0, out: false, declared: false });
      bats­menOrder.push(idx);

      const freeSlot = onCrease.indexOf(null);
      if (freeSlot !== -1) onCrease[freeSlot] = idx;
      updateDisplay();
    }

    // Set initial openers
    function setOpeners(n1, n2){
      bats­men = [
        { name: n1, runs: 0, balls: 0, out: false, declared: false },
        { name: n2, runs: 0, balls: 0, out: false, declared: false }
      ];
      bats­menOrder = [0,1];
      onCrease = [0,1];
      updateDisplay();
    }

    // Scoring logic
    function addScore(type, val=0) {
      if (onCrease[0] === null || onCrease[1] === null) {
        showBatsmanModal('openers', setOpeners);
        return;
      }
      scoringStarted = true;

      scoreHistory.push(JSON.stringify({
        run, wickets, balls, over, extraRunsTotal,
        scoreboardBalls, bats­men, bats­menOrder, onCrease, targetActive, targetRuns, targetBalls
      }));

      const strikerIdx = onCrease[0];

      if (type === 'dot') {
        bats­men[strikerIdx].balls++;
        nextBall(0, false, 'Dot');
      }
      else if (type === 'wide' || type === 'no_ball') {
        const extraType = type === 'wide' ? 'Wide' : 'No ball';
        showExtraRunModal(extraType + ' - extra runs', extraRun => {
          const extraCount = 1 + extraRun;
          run += extraCount;
          extraRunsTotal += extraCount;

          if (extraRun > 0) {
            bats­men[strikerIdx].runs += extraRun; // batsman gets runs, but not credited as a ball
            if (extraRun % 2 === 1) rotateStrike();
          }

          recordScore(`${extraRun > 0 ? extraRun + ' (' + extraType + ')' : extraType}`);

          updateDisplay();
        });
      }
      else if (type === 'run') {
        bats­men[strikerIdx].balls++;
        bats­men[strikerIdx].runs += val;
        run += val;
        recordScore(`${val}`);
        if (val % 2 === 1) rotateStrike();
        nextBallIncrement();
      }
      else if (type === 'wicket') {
        showExtraRunModal('Wicket - runs before out', extraRun => {
          if (extraRun > 0) {
            run += extraRun;
            extraRunsTotal += extraRun;
            bats­men[strikerIdx].runs += extraRun;
            if (extraRun % 2 === 1) rotateStrike();
          }

          bats­men[strikerIdx].balls++;
          bats­men[strikerIdx].out = true;
          wickets++;

          recordScore('Wicket');
          nextBallIncrement();

          onCrease[0] = null;
          setTimeout(() => showBatsmanModal('new', addBatsman), 300);
          updateDisplay();
        });
      }
      updateDisplay();
    }

    // Ball processing for non-extra deliveries
    function nextBallIncrement() {
      balls++;
      if (balls >= 6) {
        balls = 0;
        over++;
        rotateStrike();
      }
    }

    // Record event
    function recordScore(label) {
      scoreboardBalls.push({ over, ball: balls, result: label });
    }

    // Undo action
    function undo() {
      if (!scoreHistory.length) return;
      const prev = JSON.parse(scoreHistory.pop());
      Object.assign(window, prev);
      updateDisplay();
    }

    // Strike rotation
    function rotateStrike() {
      onCrease = [onCrease[1], onCrease[0]];
    }

    // Modal helpers
    function showModal(id) { document.getElementById('modal-backdrop').style.display = 'block'; document.getElementById(id).style.display = 'block'; }
    function hideModal(id) { document.getElementById('modal-backdrop').style.display = 'none'; document.getElementById(id).style.display = 'none'; }

    // Scoreboard & player modals
    document.getElementById('scoreboard-btn').onclick = () => {
      const div = document.getElementById('scoreboard-horizontal');
      div.innerHTML = `<div><strong>Total Extras:</strong> ${extraRunsTotal}</div>`;
      const oversGroup = {};
      scoreboardBalls.forEach(b => {
        if (!oversGroup[b.over]) oversGroup[b.over] = [];
        oversGroup[b.over].push(`${b.over+1}.${b.ball} – ${b.result}`);
      });
      for (const o in oversGroup) {
        div.innerHTML += `<div><b>Over ${+o+1}:</b> ${oversGroup[o].join(', ')}</div>`;
      }
      showModal('scoreboard-modal');
    };

    document.getElementById('player-score-btn').onclick = () => {
      const div = document.getElementById('player-score-table-div');
      const rows = bats­men.map(b => `<tr><td>${b.name}</td><td>${b.runs}</td><td>${b.balls}</td><td>${b.out ? 'Out' : b.declared ? 'Declared' : 'Not out'}</td></tr>`).join('');
      div.innerHTML = `<table style="width:100%;border-collapse:collapse"><tr><th>Name</th><th>Runs</th><th>Balls</th><th>Status</th></tr>${rows}</table>`;
      showModal('player-score-modal');
    };

    // Target mode UI
    document.getElementById('targetModeButton').onclick = () => {
      document.getElementById('targetRuns').value = targetRuns || '';
      document.getElementById('targetOvers').value = targetBalls / 6 || '';
      showModal('target-modal');
    };

    function setTarget() {
      targetRuns = +document.getElementById('targetRuns').value || 0;
      targetBalls = (+document.getElementById('targetOvers').value || 0) * 6;
      targetActive = true;
      hideModal('target-modal');
      document.getElementById('targetBoard').style.display = 'block';
      updateTargetBoard();
    }

    function updateTargetBoard() {
      const runsLeft = Math.max(0, targetRuns - run);
      const ballsLeft = Math.max(0, targetBalls - (over * 6 + balls));
      document.getElementById('targetRunsRequired').textContent = runsLeft;
      document.getElementById('targetOversLeft').textContent = ballsLeft;
    }

    document.getElementById('strike-change-btn').onclick = () => {
      if (confirm('Are you sure to change strike?')) {
        rotateStrike();
        updateDisplay();
      }
    };

    document.getElementById('run_dot').onclick = () => addScore('dot');
    document.getElementById('run_wide').onclick = () => addScore('wide');
    document.getElementById('run_no_ball').onclick = () => addScore('no_ball');
    document.getElementById('run_1').onclick = () => addScore('run', 1);
    document.getElementById('run_2').onclick = () => addScore('run', 2);
    document.getElementById('run_3').onclick = () => addScore('run', 3);
    document.getElementById('run_4').onclick = () => addScore('run', 4);
    document.getElementById('run_6').onclick = () => addScore('run', 6);
    document.getElementById('run_W').onclick = () => addScore('wicket');
    document.getElementById('undo-btn').onclick = undo;
    document.getElementById('reset-btn').onclick = () => {
      if (confirm('Do you want to count a new score?')) resetState();
    };

    document.getElementById('targetBoard').onclick = closeTargetAlert;

    // Extra-run modal functions
    function showExtraRunModal(title, callback) {
      extraRunCallback = callback;
      extraRunValue = 0;
      document.getElementById('extra-run-modal-title').textContent = title;
      document.getElementById('extra-run-count').textContent = extraRunValue;
      showModal('extra-run-modal');
    }

    function adjustExtraRun(delta) {
      extraRunValue = Math.max(0, extraRunValue + delta);
      document.getElementById('extra-run-count').textContent = extraRunValue;
    }

    function confirmExtraRun() {
      hideModal('extra-run-modal');
      extraRunCallback && extraRunCallback(extraRunValue);
    }

    function closeTargetAlert() {
      document.getElementById('targetBoard').style.display = 'none';
      targetActive = false;
      saveState();
    }

    // Initialize
    loadState();
    updateDisplay();

    if (onCrease[0] === null || onCrease[1] === null) {
      setTimeout(() => showBatsmanModal('openers', setOpeners), 200);
    }
  </script>
</body>
</html>
